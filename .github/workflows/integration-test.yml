name: Integration Test

on:
  workflow_call:
    inputs:
      library-dir:
        description: 'Path to the library directory'
        required: true
        type: string
      consumer-dir:
        description: 'Path to the consumer project directory'
        required: true
        type: string
      package-name:
        description: 'Name of the Conan package'
        required: true
        type: string
      package-version:
        description: 'Version of the package'
        required: true
        type: string
      version-suffix:
        description: 'Optional version suffix (e.g., pr123, sha-abc1234)'
        required: false
        type: string
        default: ''
      profile-dir:
        description: 'Path to directory containing Conan profiles (relative to library-dir)'
        required: false
        type: string
        default: 'conan-profiles'

jobs:
  integration-test:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            profile: linux-gcc
          - os: windows-latest
            profile: windows-msvc
          - os: macos-latest
            profile: macos-clang

    runs-on: ${{ matrix.os }}
    name: Integration Test (${{ matrix.os }})

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Conan
        run: pip install conan

      - name: Configure Conan
        run: conan profile detect --force

      - name: Compute full version
        id: version
        shell: bash
        run: |
          if [ -n "${{ inputs.version-suffix }}" ]; then
            echo "full_version=${{ inputs.package-version }}-${{ inputs.version-suffix }}" >> $GITHUB_OUTPUT
          else
            echo "full_version=${{ inputs.package-version }}" >> $GITHUB_OUTPUT
          fi

      - name: Build and create library package
        shell: bash
        working-directory: ${{ inputs.library-dir }}
        env:
          CONAN_VERSION_SUFFIX: ${{ inputs.version-suffix }}
        run: |
          PROFILE_PATH="${{ inputs.profile-dir }}/${{ matrix.profile }}"

          # Install dependencies and build the library
          conan create . \
            --profile:build="${PROFILE_PATH}" \
            --profile:host="${PROFILE_PATH}" \
            --build=missing

      - name: Install library package for consumer
        shell: bash
        working-directory: ${{ inputs.consumer-dir }}
        run: |
          PROFILE_PATH="${{ inputs.library-dir }}/${{ inputs.profile-dir }}/${{ matrix.profile }}"

          # Update conanfile.py to use the correct version
          # This handles the dynamic version requirement
          conan install . \
            --profile:build="${PROFILE_PATH}" \
            --profile:host="${PROFILE_PATH}" \
            --build=missing \
            --requires="${{ inputs.package-name }}/${{ steps.version.outputs.full_version }}"

      - name: Build consumer project
        shell: bash
        working-directory: ${{ inputs.consumer-dir }}
        run: |
          PROFILE_PATH="${{ inputs.library-dir }}/${{ inputs.profile-dir }}/${{ matrix.profile }}"

          conan build . \
            --profile:build="${PROFILE_PATH}" \
            --profile:host="${PROFILE_PATH}"

      - name: Run consumer executable (Unix)
        if: runner.os != 'Windows'
        shell: bash
        working-directory: ${{ inputs.consumer-dir }}
        run: |
          # Find and run the executable
          EXECUTABLE=$(find build -type f -name "${{ inputs.package-name }}_package_test" -perm -u+x 2>/dev/null | head -1)
          if [ -z "$EXECUTABLE" ]; then
            # Try alternate naming pattern
            EXECUTABLE=$(find build -type f -executable -name "*test*" 2>/dev/null | head -1)
          fi

          if [ -n "$EXECUTABLE" ]; then
            echo "Running: $EXECUTABLE"
            "$EXECUTABLE"
          else
            echo "::error::Could not find consumer executable"
            exit 1
          fi

      - name: Run consumer executable (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        working-directory: ${{ inputs.consumer-dir }}
        run: |
          # Find and run the executable
          $executable = Get-ChildItem -Path build -Recurse -Filter "*.exe" |
                        Where-Object { $_.Name -match "test" } |
                        Select-Object -First 1

          if ($executable) {
            Write-Host "Running: $($executable.FullName)"
            & $executable.FullName
          } else {
            Write-Error "Could not find consumer executable"
            exit 1
          }

      - name: Verify integration test passed
        shell: bash
        run: |
          echo "Integration test completed successfully for ${{ matrix.os }}"
