name: C++ Build and Test

on:
  workflow_call:
    inputs:
      source-dir:
        description: 'Source directory containing conanfile and CMakeLists.txt'
        required: false
        type: string
        default: '.'
      conan-options:
        description: 'Additional Conan options (e.g., -o build_tests=True)'
        required: false
        type: string
        default: ''
      profile-dir:
        description: 'Path to directory containing Conan profiles'
        required: false
        type: string
        default: ''
      use-lockfile:
        description: 'Use lockfile for deterministic builds'
        required: false
        type: boolean
        default: false
      lockfile-path:
        description: 'Path to Conan lockfile (relative to source-dir)'
        required: false
        type: string
        default: 'conan.lock'
    secrets:
      github-token:
        description: 'GitHub token for package registry access'
        required: false

jobs:
  build-and-test:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            profile: linux-gcc
            shell: bash
          - os: windows-latest
            profile: windows-msvc
            shell: pwsh
          - os: macos-latest
            profile: macos-clang
            shell: bash

    runs-on: ${{ matrix.os }}
    defaults:
      run:
        shell: ${{ matrix.shell }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Conan 2
        run: |
          pip install conan

      - name: Configure Conan
        run: |
          conan profile detect --force

      - name: Setup GitHub Package Registry (if token provided)
        shell: bash
        run: |
          if [ -n "$CONAN_PASSWORD" ]; then
            conan remote add github "https://conan.pkg.github.com/${{ github.repository_owner }}" --force || true
          else
            echo "No GitHub token provided, skipping GitHub Package Registry setup"
          fi
        env:
          CONAN_LOGIN_USERNAME: ${{ github.actor }}
          CONAN_PASSWORD: ${{ secrets.github-token }}

      - name: Detect custom Conan profile
        id: profile
        shell: bash
        run: |
          PROFILE_DIR="${{ inputs.profile-dir }}"
          PROFILE_NAME="${{ matrix.profile }}"
          SOURCE_DIR="${{ inputs.source-dir }}"

          # Construct the full path for existence check (from repo root)
          if [ -n "$PROFILE_DIR" ]; then
            FULL_PROFILE_PATH="${SOURCE_DIR}/${PROFILE_DIR}/${PROFILE_NAME}"
            # Relative path for conan (since conan runs with working-directory=source-dir)
            RELATIVE_PROFILE_PATH="${PROFILE_DIR}/${PROFILE_NAME}"
          else
            FULL_PROFILE_PATH=""
            RELATIVE_PROFILE_PATH=""
          fi

          # Check if custom profile exists
          if [ -n "$FULL_PROFILE_PATH" ] && [ -f "$FULL_PROFILE_PATH" ]; then
            # Use absolute path to ensure conan finds it regardless of working directory
            ABS_PROFILE_PATH="${GITHUB_WORKSPACE}/${FULL_PROFILE_PATH}"
            echo "profile_arg=-pr:h ${ABS_PROFILE_PATH} -pr:b ${ABS_PROFILE_PATH}" >> $GITHUB_OUTPUT
            echo "Using custom profile: $ABS_PROFILE_PATH"
          else
            echo "profile_arg=" >> $GITHUB_OUTPUT
            echo "Using default detected profile"
          fi

      - name: Cache Conan packages
        uses: actions/cache@v4
        with:
          path: ~/.conan2
          key: conan-${{ matrix.os }}-${{ hashFiles('**/conanfile.py', '**/conanfile.txt', '**/conan.lock') }}
          restore-keys: |
            conan-${{ matrix.os }}-

      - name: Install dependencies (with lockfile)
        if: ${{ inputs.use-lockfile }}
        shell: bash
        working-directory: ${{ inputs.source-dir }}
        run: |
          conan install . \
            --build=missing \
            --lockfile=${{ inputs.lockfile-path }} \
            ${{ steps.profile.outputs.profile_arg }} \
            ${{ inputs.conan-options }} \
            -of build

      - name: Install dependencies (without lockfile)
        if: ${{ !inputs.use-lockfile }}
        shell: bash
        working-directory: ${{ inputs.source-dir }}
        run: |
          conan install . \
            --build=missing \
            ${{ steps.profile.outputs.profile_arg }} \
            ${{ inputs.conan-options }} \
            -of build

      - name: Configure CMake (Unix)
        if: runner.os != 'Windows'
        working-directory: ${{ inputs.source-dir }}
        run: |
          cmake --preset conan-release || cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=build/generators/conan_toolchain.cmake

      - name: Configure CMake (Windows)
        if: runner.os == 'Windows'
        working-directory: ${{ inputs.source-dir }}
        run: |
          cmake --preset conan-default 2>$null
          if ($LASTEXITCODE -ne 0) { cmake --preset conan-release 2>$null }
          if ($LASTEXITCODE -ne 0) { cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DCMAKE_TOOLCHAIN_FILE=build/generators/conan_toolchain.cmake }

      - name: Build
        working-directory: ${{ inputs.source-dir }}
        run: |
          cmake --build --preset conan-release --parallel || cmake --build build --config Release --parallel

      - name: Run tests
        working-directory: ${{ inputs.source-dir }}
        run: |
          ctest --preset conan-release --output-on-failure --parallel || ctest --test-dir build --build-config Release --output-on-failure --parallel

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.os }}
          path: |
            ${{ inputs.source-dir }}/build/**/Testing/
            ${{ inputs.source-dir }}/build/**/*test*.xml
          if-no-files-found: ignore
